<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Justice League Archives</title>
    <link id="manifest-link" rel="manifest" href="">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0b1120;
            --bg-panel: #1e293b;
            --jl-gold: #fbbf24;
            --jl-blue: #38bdf8;
            --jl-red: #ef4444;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --radius: 12px;
            --nav-height: 70px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        h1, h2, h3 { font-family: 'Orbitron', sans-serif; margin: 0; letter-spacing: 1.5px; }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop { to { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }
        @keyframes zoomIn { from {transform:scale(0.9); opacity:0} to {transform:scale(1); opacity:1} }

        /* THE YELLOW HIGHLIGHT ANIMATION */
        @keyframes goldPulse {
            0% {
                background-color: rgba(251, 191, 36, 0.25);
                box-shadow: 0 0 25px rgba(251, 191, 36, 0.4);
                border-color: var(--jl-gold);
                transform: scale(1.02);
            }
            15% { transform: scale(1); }
            100% {
                background-color: var(--bg-panel);
                box-shadow: none;
                border-color: rgba(255,255,255,0.05);
            }
        }

        .highlight-active {
            animation: goldPulse 5s ease-out forwards !important;
            position: relative;
            z-index: 5;
        }

        .particle {
            position: fixed; pointer-events: none;
            width: 8px; height: 8px; background: var(--jl-gold);
            border-radius: 50%; animation: pop 0.6s ease-out forwards;
            z-index: 9999;
        }

        /* Screens */
        .screen {
            display: none; flex-direction: column;
            width: 100%; height: 100%; position: absolute;
            background: var(--bg-dark); z-index: 10;
        }
        .screen.active { display: flex; animation: fadeIn 0.4s ease; }

        /* Auth UI */
        .auth-container {
            flex: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 2rem; background: radial-gradient(circle at center, #1e293b 0%, #0b1120 90%);
        }
        .logo { font-size: 4rem; color: var(--text-main); margin-bottom: 1rem; text-shadow: 0 0 20px var(--jl-blue); }
        .input-group { width: 100%; max-width: 320px; margin-bottom: 1rem; }
        input, textarea {
            width: 100%; padding: 14px; background: rgba(255,255,255,0.05);
            border: 1px solid var(--text-muted); border-radius: var(--radius);
            color: white; font-family: inherit; font-size: 1rem; outline: none; transition: 0.3s;
        }
        input:focus, textarea:focus { border-color: var(--jl-blue); box-shadow: 0 0 10px rgba(56, 189, 248, 0.3); }

        .btn {
            background: var(--jl-blue); color: var(--bg-dark); border: none;
            padding: 14px; border-radius: var(--radius); font-weight: bold;
            font-family: 'Orbitron', sans-serif; cursor: pointer; width: 100%;
            text-transform: uppercase; margin-top: 10px; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; background: var(--text-muted); color: #fff; }
        .btn-outline { background: transparent; border: 1px solid var(--jl-blue); color: var(--jl-blue); }
        .error-msg { color: var(--jl-red); margin-top: 10px; font-size: 0.9rem; text-align: center; min-height: 20px; }

        /* Main App UI */
        header {
            height: 60px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; background: rgba(11, 17, 32, 0.95);
            border-bottom: 1px solid rgba(255,255,255,0.1); z-index: 50; backdrop-filter: blur(10px);
        }
        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; scroll-behavior: smooth; }

        /* Tab Containers */
        #messages-container, #media-container, #stats-container, #profile-container { display: none; flex-direction: column; gap: 15px; }
        .active-container { display: flex !important; }

        /* Cards */
        .card {
            background: var(--bg-panel); border-radius: var(--radius); padding: 15px;
            border: 1px solid rgba(255,255,255,0.05); animation: fadeIn 0.3s ease; margin-bottom: 15px;
            /* Transition for the highlight effect */
            transition: background-color 0.5s ease, box-shadow 0.5s ease;
        }
        .card-header { display: flex; gap: 12px; align-items: center; margin-bottom: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--jl-gold); }
        .meta h4 { margin: 0; color: var(--jl-blue); font-size: 1rem; }
        .meta small { color: var(--text-muted); font-size: 0.75rem; }
        .content-text { line-height: 1.5; font-size: 0.95rem; word-break: break-word; color: #e2e8f0; margin-bottom: 10px; }
        .media-display { width: 100%; border-radius: 8px; margin-top: 5px; margin-bottom: 10px; max-height: 350px; object-fit: cover; background: #000; cursor: zoom-in; }

        /* Reply Block (The Yellow Box) */
        .reply-block {
            border-left: 4px solid var(--jl-gold);
            background: rgba(251, 191, 36, 0.1);
            padding: 10px; margin-bottom: 10px; border-radius: 0 8px 8px 0;
            font-size: 0.85rem; color: var(--text-muted);
            cursor: pointer; position: relative; overflow: hidden;
            transition: all 0.2s ease;
        }
        .reply-block:hover { background: rgba(251, 191, 36, 0.2); }
        .reply-block:active { transform: scale(0.98); }
        .reply-header { color: var(--jl-gold); font-weight: bold; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }

        .actions {
            display: flex; gap: 15px; margin-top: 5px; padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap;
        }
        .action-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; transition: 0.2s; }
        .action-btn:hover { color: white; }
        .action-btn.liked { color: var(--jl-red); }
        .action-btn.fired { color: orange; }
        .action-btn.bolted { color: yellow; }

        /* Navigation */
        nav {
            height: var(--nav-height); position: absolute; bottom: 0; width: 100%;
            background: var(--bg-panel); display: flex; justify-content: space-around;
            align-items: center; border-top: 1px solid rgba(255,255,255,0.1); z-index: 50;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: var(--text-muted); font-size: 0.7rem; cursor: pointer; padding: 10px; width: 100%;
        }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--jl-gold); }
        .nav-item.active i { transform: scale(1.1); text-shadow: 0 0 10px rgba(251, 191, 36, 0.4); }

        /* FAB */
        .fab {
            position: fixed; bottom: 85px; right: 20px;
            width: 56px; height: 56px; background: var(--jl-blue);
            color: var(--bg-dark); border-radius: 50%; border: none;
            font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.5); z-index: 40; cursor: pointer;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }

        /* Modals */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: var(--bg-panel); width: 90%; max-width: 500px;
            padding: 25px; border-radius: var(--radius); border: 1px solid var(--jl-blue);
            position: relative;
        }
        
        .context-bar {
            background: rgba(56, 189, 248, 0.1); border-left: 4px solid var(--jl-blue);
            padding: 10px; margin-bottom: 15px; font-size: 0.9rem;
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 0 4px 4px 0;
        }

        .file-drop {
            border: 2px dashed var(--jl-blue); padding: 20px; text-align: center;
            border-radius: 8px; cursor: pointer; margin-bottom: 15px; color: var(--jl-blue); display:block;
        }
        
        /* Image Viewer */
        #modal-image-viewer { background-color: rgba(0,0,0,0.95); z-index: 200; cursor: zoom-out; }
        .modal-content-img {
            margin: auto; display: block;
            width: auto; height: auto;
            max-width: 95%; max-height: 95vh;
            border: 2px solid var(--jl-blue);
            box-shadow: 0 0 20px var(--jl-blue);
            animation: zoomIn 0.3s;
        }
        
        /* Stats & Profile */
        .stat-box { text-align: center; padding: 40px; background: rgba(56, 189, 248, 0.1); border: 1px solid var(--jl-blue); border-radius: var(--radius); }
        .stat-num { font-size: 3.5rem; font-family: 'Orbitron'; color: var(--jl-blue); margin-bottom: 5px; }
        .profile-img-lg { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--jl-gold); margin: 0 auto 15px; display: block; }
        .help-box { background: rgba(251, 191, 36, 0.1); border-left: 4px solid var(--jl-gold); padding: 10px; margin-bottom: 15px; font-size: 0.9rem; line-height: 1.4; }
        
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s linear infinite; margin-right: 8px; vertical-align: middle; }
    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="screen-auth" class="screen active">
        <div class="auth-container">
            <i class="fa-solid fa-shield-halved logo"></i>
            <h1 style="margin-bottom: 5px;">ARCHIVES</h1>
            <p style="color:var(--text-muted); margin-bottom: 30px; letter-spacing: 1px;">JUSTICE LEAGUE DATABASE</p>
            
            <div id="auth-forms">
                <div id="login-box">
                    <div class="input-group"><input type="text" id="login-user" placeholder="Codename (Username)"></div>
                    <div class="input-group"><input type="password" id="login-pass" placeholder="Access Code (Password)"></div>
                    <button class="btn" id="btn-login">Identify</button>
                    <button class="btn btn-outline" id="btn-goto-reg">Request Access</button>
                </div>
                <div id="register-box" style="display:none;">
                    <div class="help-box">Create a unique identity. This device will retain your session.</div>
                    <div class="input-group"><input type="text" id="reg-user" placeholder="New Codename"></div>
                    <div class="input-group"><input type="password" id="reg-pass" placeholder="Create Access Code"></div>
                    <button class="btn" id="btn-register">Grant Access</button>
                    <button class="btn btn-outline" id="btn-goto-login">Back to Login</button>
                </div>
            </div>
            <div id="auth-error" class="error-msg"></div>
        </div>
    </div>

    <!-- MAIN APP SCREEN -->
    <div id="screen-app" class="screen">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-star-of-life" style="color:var(--jl-gold)"></i>
                <h3>JL ARCHIVES</h3>
            </div>
            <i class="fa-solid fa-circle-question" style="font-size:1.5rem; color:var(--jl-blue); cursor:pointer;" id="btn-help"></i>
        </header>

        <main>
            <div id="messages-container" class="active-container">
                <div style="text-align:center; padding:20px; color:var(--text-muted);">Decrypting comms...</div>
            </div>
            <div id="media-container">
                <div style="text-align:center; padding:20px; color:var(--text-muted);">Loading visual logs...</div>
            </div>
            <div id="stats-container">
                <div class="stat-box">
                    <div class="stat-num" id="user-count">...</div>
                    <div style="font-family:'Orbitron'; letter-spacing:1px;">REGISTERED HEROES</div>
                </div>
                <div class="help-box" style="margin-top:20px; border-color:var(--jl-blue); background:rgba(56,189,248,0.1);">
                    SYSTEM STATUS: ONLINE<br>ENCRYPTION: QUANTUM<br>SERVER: WATCHTOWER
                </div>
            </div>
            <div id="profile-container">
                <div class="card" style="text-align:center;">
                    <img src="" id="profile-avatar" class="profile-img-lg">
                    <h2 id="profile-name">Name</h2>
                    <p id="profile-user" style="color:var(--text-muted); margin-bottom:20px;">@username</p>
                    <label class="btn btn-outline" style="display:block; margin-bottom:15px; width:auto;">
                        <input type="file" id="avatar-input" style="display:none">
                        <i class="fa-solid fa-camera"></i> Update ID Photo
                    </label>
                    <div class="input-group" style="margin:0 auto 15px;">
                        <input type="text" id="new-display-name" placeholder="New Display Name">
                    </div>
                    <button class="btn" id="btn-update-profile">Update Records</button>
                    <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:25px 0;">
                    <button class="btn" style="background:var(--bg-panel); border:1px solid var(--text-muted);" id="btn-logout">End Session</button>
                    <button class="btn" style="background:var(--jl-red); margin-top:10px;" id="btn-delete-account">Delete Account</button>
                </div>
            </div>
        </main>

        <button id="fab" class="fab">
            <i class="fa-solid fa-plus"></i>
        </button>

        <nav>
            <div class="nav-item active" data-tab="messages">
                <i class="fa-solid fa-comments"></i> <span>Comms</span>
            </div>
            <div class="nav-item" data-tab="media">
                <i class="fa-solid fa-images"></i> <span>Media</span>
            </div>
            <div class="nav-item" data-tab="stats">
                <i class="fa-solid fa-chart-pie"></i> <span>Stats</span>
            </div>
            <div class="nav-item" data-tab="profile">
                <i class="fa-solid fa-user-astronaut"></i> <span>Profile</span>
            </div>
        </nav>
    </div>

    <!-- POST MODAL -->
    <div id="modal-post" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3 id="modal-title">TRANSMIT</h3>
                <i class="fa-solid fa-xmark" style="font-size:1.5rem; cursor:pointer;" id="close-post-modal"></i>
            </div>
            
            <p id="modal-subtitle" style="color:var(--jl-blue); font-size:0.9rem; margin-bottom:10px;">CHANNEL SELECTION</p>
            
            <!-- Context Banner (Reply/Forward) -->
            <div id="context-banner" class="context-bar" style="display:none;">
                <div id="context-text">Context info</div>
                <i class="fa-solid fa-xmark" style="cursor:pointer" onclick="clearContext()"></i>
            </div>

            <!-- Text Post Form -->
            <div id="form-text">
                <textarea id="post-text" rows="4" placeholder="Enter message..."></textarea>
                <button class="btn" id="btn-submit-text">TRANSMIT</button>
            </div>
            
            <!-- Media Upload Form -->
            <div id="form-media" style="display:none;">
                <label class="file-drop">
                    <input type="file" id="media-input" accept="image/*" style="display:none">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size:2rem; display:block; margin-bottom:10px;"></i>
                    <span id="file-label">Select Image (Max 1MB)</span>
                </label>
                <input type="text" id="media-caption" placeholder="Add a caption (optional)..." style="width:100%; padding:12px; margin-bottom:15px; border-radius:12px; border:1px solid var(--text-muted); background:rgba(255,255,255,0.05); color:white;">
                <button class="btn" id="upload-btn">SAVE TO ARCHIVES</button>
            </div>
        </div>
    </div>

    <!-- HELP MODAL -->
    <div id="modal-help" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>DIRECTIVES</h3>
                <i class="fa-solid fa-xmark" style="font-size:1.5rem; cursor:pointer;" id="close-help-modal"></i>
            </div>
            <div class="help-box">
                <strong><i class="fa-solid fa-reply"></i> Reply:</strong> Tap the arrow to quote a message.
            </div>
            <div class="help-box" style="border-color:var(--jl-blue); background:rgba(56,189,248,0.1);">
                <strong><i class="fa-solid fa-share"></i> Forward:</strong> Share media/text to the Chat feed.
            </div>
        </div>
    </div>

    <!-- IMAGE VIEWER MODAL -->
    <div id="modal-image-viewer" class="modal" onclick="closeImageViewer()">
        <img class="modal-content-img" id="full-image">
    </div>

    <!-- FIREBASE COMPAT SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // 1. Initialize Firebase (Storage removed)
            const firebaseConfig = {
                apiKey: "AIzaSyCevsSbZTqr9qq6uNlDd8vnJwRW0e1pGx8",
                authDomain: "justice-league-archives.firebaseapp.com",
                projectId: "justice-league-archives",
                storageBucket: "justice-league-archives.firebasestorage.app",
                messagingSenderId: "1062428196594",
                appId: "1:1062428196594:web:49c06eb3708a3a795c5a6b",
                measurementId: "G-VZZKCJK8LY"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            // 2. State & Variables
            let currentUser = null;
            let currentTab = 'messages';
            let postContext = null; // { type, id, username, text, tab }
            
            const screenAuth = document.getElementById('screen-auth');
            const screenApp = document.getElementById('screen-app');
            const authError = document.getElementById('auth-error');
            const messagesContainer = document.getElementById('messages-container');
            const mediaContainer = document.getElementById('media-container');

            // 3. Auth Logic - OPTIMISTIC
            function checkSession() {
                const stored = localStorage.getItem('jl_user');
                if (stored) {
                    try {
                        const user = JSON.parse(stored);
                        loginSuccess(user);
                        db.collection('users').doc(user.username).get().then(doc => {
                            if(!doc.exists) { alert("User not found"); logout(); }
                        }).catch(e => console.log("Offline mode"));
                    } catch(e) { logout(); }
                } else {
                    screenAuth.classList.add('active');
                }
            }

            function loginSuccess(user) {
                currentUser = user;
                localStorage.setItem('jl_user', JSON.stringify(user));
                screenAuth.classList.remove('active');
                screenApp.classList.add('active');
                switchTab('messages');
            }

            function logout() {
                localStorage.removeItem('jl_user');
                location.reload();
            }

            // Auth Buttons
            document.getElementById('btn-login').addEventListener('click', function() {
                const u = document.getElementById('login-user').value.trim().toLowerCase();
                const p = document.getElementById('login-pass').value;
                if(!u || !p) return showAuthError("Credentials missing.");
                db.collection('users').doc(u).get().then(doc => {
                    if(doc.exists && doc.data().password === btoa(p)) loginSuccess(doc.data());
                    else showAuthError("Access Denied.");
                }).catch(e => showAuthError("Connection Failed."));
            });

            document.getElementById('btn-register').addEventListener('click', function() {
                const u = document.getElementById('reg-user').value.trim().toLowerCase();
                const p = document.getElementById('reg-pass').value;
                if(!u || !p) return showAuthError("Credentials missing.");
                const userRef = db.collection('users').doc(u);
                userRef.get().then(doc => {
                    if(doc.exists) return showAuthError("Codename taken.");
                    const newUser = {
                        username: u, password: btoa(p),
                        displayName: u.toUpperCase(),
                        avatar: `https://ui-avatars.com/api/?name=${u}&background=38bdf8&color=fff`,
                        joined: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    userRef.set(newUser).then(() => loginSuccess(newUser));
                }).catch(e => showAuthError("Error: " + e.message));
            });

            document.getElementById('btn-goto-reg').addEventListener('click', () => {
                document.getElementById('login-box').style.display = 'none';
                document.getElementById('register-box').style.display = 'block';
                authError.innerText = '';
            });
            document.getElementById('btn-goto-login').addEventListener('click', () => {
                document.getElementById('register-box').style.display = 'none';
                document.getElementById('login-box').style.display = 'block';
                authError.innerText = '';
            });
            function showAuthError(msg) { authError.innerText = msg; }

            // 4. Navigation
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            function switchTab(tab) {
                currentTab = tab;
                navItems.forEach(n => n.classList.remove('active'));
                document.querySelector(`.nav-item[data-tab="${tab}"]`).classList.add('active');
                document.querySelectorAll('.active-container').forEach(el => el.classList.remove('active-container'));
                document.getElementById(tab + '-container').classList.add('active-container');
                document.getElementById('fab').style.display = (tab === 'messages' || tab === 'media') ? 'flex' : 'none';

                if(tab === 'messages') loadMessages();
                if(tab === 'media') loadMedia();
                if(tab === 'stats') loadStats();
                if(tab === 'profile') renderProfile();
            }

            // 5. Modals & Interaction
            document.getElementById('fab').addEventListener('click', () => {
                clearContext();
                const isMedia = currentTab === 'media';
                document.getElementById('modal-subtitle').innerText = isMedia ? "MEDIA CHANNEL" : "TEXT CHANNEL";
                document.getElementById('form-text').style.display = isMedia ? 'none' : 'block';
                document.getElementById('form-media').style.display = isMedia ? 'block' : 'none';
                document.getElementById('modal-post').classList.add('open');
            });

            document.getElementById('close-post-modal').addEventListener('click', () => {
                document.getElementById('modal-post').classList.remove('open');
                clearContext();
            });
            
            document.getElementById('btn-help').addEventListener('click', () => document.getElementById('modal-help').classList.add('open'));
            document.getElementById('close-help-modal').addEventListener('click', () => document.getElementById('modal-help').classList.remove('open'));

            // --- CONTEXT LOGIC (Reply/Forward) ---
            window.startContext = function(action, id, username, textSnippet, originTab) {
                clearContext();
                postContext = { type: action, id, username, text: textSnippet, tab: originTab };
                
                const banner = document.getElementById('context-banner');
                const bannerText = document.getElementById('context-text');
                
                banner.style.display = 'flex';
                if(action === 'reply') {
                    bannerText.innerHTML = `Replying to <b style="color:var(--jl-gold)">${username}</b>`;
                } else {
                    bannerText.innerHTML = `Forwarding content from <b style="color:var(--jl-blue)">${username}</b>`;
                }
                
                document.getElementById('form-text').style.display = 'block';
                document.getElementById('form-media').style.display = 'none';
                document.getElementById('modal-post').classList.add('open');
            };

            window.clearContext = function() {
                postContext = null;
                document.getElementById('context-banner').style.display = 'none';
            }

            // --- SMART NAVIGATION & HIGHLIGHT ---
            window.jumpToMessage = function(targetId, targetTab) {
                // 1. Switch Tab if needed
                if (targetTab && targetTab !== currentTab) {
                    switchTab(targetTab);
                }

                // 2. Wait for DOM update/Switch, then find and scroll
                setTimeout(() => {
                    const el = document.getElementById('msg-' + targetId);
                    if(el) {
                        el.scrollIntoView({behavior: 'smooth', block: 'center'});
                        // Trigger CSS Animation
                        el.classList.remove('highlight-active'); // Reset
                        void el.offsetWidth; // Force Reflow
                        el.classList.add('highlight-active');
                    } else {
                        console.log("Msg not in view");
                    }
                }, 400); // 400ms delay to allow tab render
            };

            // 6. Messaging (Text)
            document.getElementById('btn-submit-text').addEventListener('click', function() {
                const text = document.getElementById('post-text').value;
                if(!text) return;
                const btn = this;
                btn.innerHTML = '<span class="spinner"></span> SENDING...';
                btn.disabled = true;

                const payload = {
                    content: text,
                    username: currentUser.username,
                    displayName: currentUser.displayName,
                    userAvatar: currentUser.avatar,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    likes: 0, likesBy: [],
                    fire: 0, fireBy: [],
                    bolt: 0, boltBy: []
                };

                if (postContext) {
                    if(postContext.type === 'reply') {
                        payload.replyTo = postContext;
                    } else {
                        payload.forwarded = postContext;
                        payload.displayName = currentUser.displayName + " â†³ FWD";
                    }
                }

                db.collection('messages').add(payload).then(() => {
                    document.getElementById('post-text').value = '';
                    document.getElementById('modal-post').classList.remove('open');
                    clearContext();
                    if(postContext && postContext.type === 'forward') switchTab('messages');
                }).catch(e => alert("Error: " + e.message))
                .finally(() => { btn.innerText = "TRANSMIT"; btn.disabled = false; });
            });

            // 7. Media Upload - BASE64 + Caption
            document.getElementById('media-input').addEventListener('change', function() {
                if(this.files[0]) document.getElementById('file-label').innerText = this.files[0].name;
            });

            document.getElementById('upload-btn').addEventListener('click', function() {
                const file = document.getElementById('media-input').files[0];
                const caption = document.getElementById('media-caption').value;
                
                if (!file) return alert("No file selected.");
                if(file.size > 1000000) return alert("File too large. Free tier limit is 1MB.");

                const btn = this;
                btn.innerHTML = '<span class="spinner"></span> PROCESSING...';
                btn.disabled = true;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Url = e.target.result;
                    db.collection("media").add({
                        url: base64Url,
                        content: caption,
                        username: currentUser.username,
                        displayName: currentUser.displayName,
                        userAvatar: currentUser.avatar,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: file.type,
                        likes: 0, likesBy: [],
                        fire: 0, fireBy: [],
                        bolt: 0, boltBy: []
                    }).then(() => {
                        document.getElementById('media-input').value = '';
                        document.getElementById('media-caption').value = '';
                        document.getElementById('file-label').innerText = 'Select Image';
                        document.getElementById('modal-post').classList.remove('open');
                    }).catch(err => alert("Error: " + err.message))
                    .finally(() => { btn.innerText = "SAVE TO ARCHIVES"; btn.disabled = false; });
                };
                reader.readAsDataURL(file);
            });

            // 8. Real-time Listeners
            let unsubMsg, unsubMedia;

            function loadMessages() {
                if(unsubMsg) return;
                unsubMsg = db.collection('messages').orderBy('timestamp', 'desc').onSnapshot(snap => {
                    messagesContainer.innerHTML = '';
                    if(snap.empty) messagesContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">No transmissions.</div>';
                    snap.forEach(doc => messagesContainer.appendChild(createCard(doc.id, doc.data(), 'messages')));
                });
            }

            function loadMedia() {
                if(unsubMedia) return;
                unsubMedia = db.collection('media').orderBy('timestamp', 'desc').onSnapshot(snap => {
                    mediaContainer.innerHTML = '';
                    if(snap.empty) mediaContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">No media logs.</div>';
                    snap.forEach(doc => mediaContainer.appendChild(createCard(doc.id, doc.data(), 'media')));
                });
            }

            function createCard(id, data, collectionName) {
                const el = document.createElement('div');
                el.className = 'card';
                el.id = 'msg-' + id; // ID for scrolling
                const time = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'Just now';
                
                const liked = (data.likesBy || []).includes(currentUser.username);
                const fired = (data.fireBy || []).includes(currentUser.username);
                const bolted = (data.boltBy || []).includes(currentUser.username);
                
                const safeText = (data.content || "Media Attachment").replace(/'/g, "\\'").replace(/"/g, '&quot;');

                // --- REPLY BLOCK RENDERING ---
                let contextHtml = '';
                if(data.replyTo) {
                    contextHtml = `
                    <div class="reply-block" onclick="jumpToMessage('${data.replyTo.id}', '${data.replyTo.tab}')">
                        <div class="reply-header"><i class="fa-solid fa-reply"></i> Replying to ${data.replyTo.username}</div>
                        ${data.replyTo.text.substring(0, 60)}...
                    </div>`;
                } else if(data.forwarded) {
                    contextHtml = `
                    <div class="reply-block" onclick="jumpToMessage('${data.forwarded.id}', '${data.forwarded.tab}')" style="border-left-color:var(--jl-blue); background:rgba(56,189,248,0.1)">
                        <div class="reply-header" style="color:var(--jl-blue)"><i class="fa-solid fa-share"></i> Forward from ${data.forwarded.username}</div>
                        ${data.forwarded.text.substring(0, 60)}...
                    </div>`;
                }

                // Content
                let content = '';
                if(collectionName === 'messages') {
                    content = `<div class="content-text">${data.content}</div>`;
                } else {
                    content = `<img src="${data.url}" class="media-display" loading="lazy" onclick="openImageViewer(this.src)">`;
                    if(data.content) content += `<div class="content-text" style="font-size:0.9rem; color:#ccc; margin-top:5px;">${data.content}</div>`;
                }

                el.innerHTML = `
                    <div class="card-header">
                        <img src="${data.userAvatar || 'https://via.placeholder.com/40'}" class="avatar">
                        <div class="meta">
                            <h4>${data.displayName}</h4>
                            <small>${time}</small>
                        </div>
                    </div>
                    ${contextHtml}
                    ${content}
                    <div class="actions">
                        <button class="action-btn ${liked ? 'liked' : ''}" onclick="handleReaction('${id}', '${collectionName}', 'like', this)">
                            <i class="fa-solid fa-heart"></i> ${data.likes || 0}
                        </button>
                        <button class="action-btn ${fired ? 'fired' : ''}" onclick="handleReaction('${id}', '${collectionName}', 'fire', this)">
                            <i class="fa-solid fa-fire"></i> ${data.fire || 0}
                        </button>
                        <button class="action-btn ${bolted ? 'bolted' : ''}" onclick="handleReaction('${id}', '${collectionName}', 'bolt', this)">
                            <i class="fa-solid fa-bolt"></i> ${data.bolt || 0}
                        </button>
                        <div style="flex:1"></div>
                        <button class="action-btn" onclick="startContext('reply', '${id}', '${data.username}', '${safeText}', '${collectionName}')">
                            <i class="fa-solid fa-reply"></i>
                        </button>
                        <button class="action-btn" onclick="startContext('forward', '${id}', '${data.username}', '${safeText}', '${collectionName}')">
                            <i class="fa-solid fa-share"></i>
                        </button>
                    </div>
                `;
                return el;
            }

            // 9. Fast Interactions
            window.handleReaction = function(id, coll, type, btn) {
                spawnParticles(btn, type);
                const docRef = db.collection(coll).doc(id);
                const fieldCount = type === 'like' ? 'likes' : (type === 'fire' ? 'fire' : 'bolt');
                const fieldBy = type === 'like' ? 'likesBy' : (type === 'fire' ? 'fireBy' : 'boltBy');
                const isActive = btn.classList.contains('liked') || btn.classList.contains('fired') || btn.classList.contains('bolted');
                const update = {};
                if (isActive) {
                    update[fieldCount] = firebase.firestore.FieldValue.increment(-1);
                    update[fieldBy] = firebase.firestore.FieldValue.arrayRemove(currentUser.username);
                } else {
                    update[fieldCount] = firebase.firestore.FieldValue.increment(1);
                    update[fieldBy] = firebase.firestore.FieldValue.arrayUnion(currentUser.username);
                }
                docRef.update(update).catch(e => console.error("Reaction failed", e));
            };

            function spawnParticles(btn, type) {
                const colors = { like: 'var(--jl-red)', fire: 'orange', bolt: 'yellow' };
                const rect = btn.getBoundingClientRect();
                for(let i=0; i<6; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    p.style.background = colors[type];
                    document.body.appendChild(p);
                    const angle = Math.random() * 6.28;
                    const v = 30 + Math.random() * 30;
                    p.style.left = (rect.left + rect.width / 2) + 'px';
                    p.style.top = (rect.top + rect.height / 2) + 'px';
                    p.style.setProperty('--tx', Math.cos(angle)*v + 'px');
                    p.style.setProperty('--ty', Math.sin(angle)*v + 'px');
                    setTimeout(() => p.remove(), 600);
                }
            }

            // 10. Profile & Stats
            function loadStats() { db.collection('users').get().then(snap => document.getElementById('user-count').innerText = snap.size); }
            function renderProfile() {
                document.getElementById('profile-avatar').src = currentUser.avatar;
                document.getElementById('profile-name').innerText = currentUser.displayName;
                document.getElementById('profile-user').innerText = '@' + currentUser.username;
            }
            document.getElementById('avatar-input').addEventListener('change', function() {
                if(this.files[0]) {
                    const file = this.files[0];
                    if(file.size > 1000000) return alert("Avatar too large (Max 1MB)");
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const url = e.target.result;
                        db.collection('users').doc(currentUser.username).update({ avatar: url })
                        .then(() => { currentUser.avatar = url; localStorage.setItem('jl_user', JSON.stringify(currentUser)); renderProfile(); });
                    };
                    reader.readAsDataURL(file);
                }
            });
            document.getElementById('btn-update-profile').addEventListener('click', () => {
                const name = document.getElementById('new-display-name').value;
                if(name) {
                    db.collection('users').doc(currentUser.username).update({ displayName: name })
                    .then(() => { currentUser.displayName = name; localStorage.setItem('jl_user', JSON.stringify(currentUser)); renderProfile(); });
                }
            });
            document.getElementById('btn-logout').addEventListener('click', () => logout());
            document.getElementById('btn-delete-account').addEventListener('click', () => {
                if(confirm("Irreversible action. Proceed?")) db.collection('users').doc(currentUser.username).delete().then(() => logout());
            });

            // 11. Image Viewer
            window.openImageViewer = function(src) {
                document.getElementById('full-image').src = src;
                document.getElementById('modal-image-viewer').classList.add('open');
            }
            window.closeImageViewer = function() {
                document.getElementById('modal-image-viewer').classList.remove('open');
            }

            // 12. PWA
            const manifest = {
                "name": "Justice League Archives",
                "short_name": "JL Archives",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#0f172a",
                "theme_color": "#0f172a",
                "icons": [{ "src": "https://img.icons8.com/color/144/justice-league.png", "sizes": "144x144", "type": "image/png" }]
            };
            document.getElementById('manifest-link').href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'}));

            if('serviceWorker' in navigator) {
                const swCode = `self.addEventListener('install',e=>e.waitUntil(caches.open('jl-cache').then(c=>c.addAll(['./']))));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));`;
                navigator.serviceWorker.register(URL.createObjectURL(new Blob([swCode], {type: 'text/javascript'})));
            }

            checkSession();
        });
    </script>
</body>
</html>